@model QLDatVeMayBay.Models.DatGhe

@{
    ViewData["Title"] = "Chọn ghế";
    int tongSoGhe = Model.TongSoGhe;
    var gheDaDat = Model.GheDaDat;
    var thongTinGhe = Model.ThongTinGhe; // Dictionary<int, (HangGhe, Gia)>
}

<h2 class="text-primary mb-4 text-center">Chọn ghế</h2>

@if (TempData["LoiChonGhe"] != null)
{
    <div class="alert alert-danger text-center">@TempData["LoiChonGhe"]</div>
}

<style>
    .seat-container {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .seat-row {
        display: flex;
        justify-content: center;
        margin-bottom: 12px;
    }

    .aisle {
        width: 40px;
    }

    .seat {
        width: 55px;
        height: 55px;
        border-radius: 8px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 6px;
        cursor: pointer;
        border: 2px solid transparent;
    }

    .seat-available {
        background: #28a745;
        color: white;
    }

    .seat-unavailable {
        background: #dc3545;
        color: white;
        cursor: not-allowed;
    }

    .seat-selected {
        background: #007bff !important;
        color: white;
    }

    /* Hạng ghế */
    .seat-business {
        background: #d4a017 !important;
    }

    .seat-premium {
        background: #7b3fa1 !important;
    }

    .seat-economy {
        background: #2ecc71 !important;
    }

    /* Tooltip */
    .tooltip-seat {
        position: absolute;
        background: black;
        color: white;
        padding: 10px;
        border-radius: 8px;
        font-size: 14px;
        opacity: 0;
        white-space: nowrap;
        pointer-events: none;
        transform: translate(-50%, -120%);
        transition: opacity .2s;
    }

        .tooltip-seat.show {
            opacity: 1;
        }

    /* Toast */
    .toast-seat {
        position: fixed;
        bottom: 25px;
        right: 25px;
        background: #007bff;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        opacity: 0;
        transform: translateY(30px);
        transition: all .3s;
    }

        .toast-seat.show {
            opacity: 1;
            transform: translateY(0);
        }
</style>

<form asp-action="XacNhanVe" method="post" onsubmit="return kiemTraChonGhe();">
    <input type="hidden" name="idChuyenBay" value="@Model.IDChuyenBay" />
    <input type="hidden" id="GiaVe" name="giaVe" />
    <input type="hidden" id="HangGhe" name="hangGhe" />

    <div class="seat-container">

        @for (int row = 1; row <= Math.Ceiling((double)tongSoGhe / 6); row++)
        {
            <div class="seat-row">

                @{
                    string[] seatCols = { "A", "B", "C", "D", "E", "F" };
                }

                @for (int col = 0; col < 6; col++)
                {
                    int seatNumber = (row - 1) * 6 + (col + 1);
                    if (seatNumber > tongSoGhe) { continue; }

                    bool daDat = gheDaDat.Contains(seatNumber);

                    string seatLabel = $"{row}{seatCols[col]}";

                    // Xác định class theo hạng
                    string hang = thongTinGhe[seatNumber].HangGhe;
                    string classHang = hang switch
                    {
                        "Thương gia" => "seat-business",
                        "Phổ thông đặc biệt" => "seat-premium",
                        _ => "seat-economy"
                    };

                    if (col == 3)
                    {
                        <div class="aisle"></div>
                    }

                    <div>
                        <input type="radio" name="idGhe" value="@seatNumber"
                               id="seat_@seatNumber" hidden @(daDat ? "disabled" : "") />

                        <label for="seat_@seatNumber"
                               class="seat @(daDat ? "seat-unavailable" : classHang) "
                               data-seat="@seatLabel"
                               data-hang="@hang"
                               @using System.Globalization
                           data-gia="@thongTinGhe[seatNumber].Gia.ToString(CultureInfo.InvariantCulture)"
                           style="@(daDat ? "opacity:0.6;" : "")">
                            @seatLabel
                        </label>
                    </div>
                }

            </div>
        }
    </div>

    <div class="text-center mt-4">
        <a href="/ChuyenBay/TimKiem" class="btn btn-secondary">Quay lại</a>
        <button type="submit" class="btn btn-primary">Đặt vé</button>
    </div>

    <div id="toastSeat" class="toast-seat"></div>
</form>

@section Scripts {
    <script>
        // Tooltip
        const tooltip = document.createElement("div");
        tooltip.className = "tooltip-seat";
        document.body.appendChild(tooltip);

        document.querySelectorAll(".seat").forEach(seat => {
            seat.addEventListener("mousemove", e => {
                if (seat.classList.contains("seat-unavailable")) return;

                tooltip.innerHTML =
                    `<b>Hạng:</b> ${seat.dataset.hang}<br>
                     <b>Giá:</b> ${Number(seat.dataset.gia).toLocaleString("vi-VN")} VNĐ`;

                tooltip.style.left = (e.pageX + 15) + "px";
                tooltip.style.top = (e.pageY - 40) + "px";
                tooltip.classList.add("show");
            });

            seat.addEventListener("mouseleave", () => {
                tooltip.classList.remove("show");
            });
        });

        // Click chọn ghế
        document.querySelectorAll(".seat").forEach(seat => {
            seat.addEventListener("click", function () {
                if (this.classList.contains("seat-unavailable")) return;

                document.querySelectorAll(".seat").forEach(s =>
                    s.classList.remove("seat-selected")
                );
                this.classList.add("seat-selected");

                // Gán radio
                document.getElementById("seat_" + this.dataset.seat.replace(/[A-F]/, "")).checked = true;

                // Gán hidden
                document.getElementById("GiaVe").value = this.dataset.gia;
                document.getElementById("HangGhe").value = this.dataset.hang;

                // Toast
                showToast(
                    `Đã chọn ghế <b>${this.dataset.seat}</b> – ${this.dataset.hang} – <b>${Number(this.dataset.gia).toLocaleString("vi-VN")} VNĐ</b>`
                );
            });
        });

        // Toast
        function showToast(msg) {
            const t = document.getElementById("toastSeat");
            t.innerHTML = msg;
            t.classList.add("show");

            setTimeout(() => t.classList.remove("show"), 2500);
        }

        // Kiểm tra
        function kiemTraChonGhe() {
            if (!document.querySelector("input[name=idGhe]:checked")) {
                alert("Vui lòng chọn ghế!");
                return false;
            }
            return true;
        }
    </script>
}
